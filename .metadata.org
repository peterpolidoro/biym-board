#+EXPORT_FILE_NAME: README.md
#+OPTIONS: toc:1 |:t ^:nil tags:nil

#+NAME: name
#+BEGIN_SRC text :exports none :noweb yes
biym-board
#+END_SRC

#+NAME: version
#+BEGIN_SRC text :exports none :noweb yes
1.2.0
#+END_SRC

#+NAME: release-month-day
#+BEGIN_SRC text :exports none :noweb yes
11-28
#+END_SRC

#+NAME: release-year
#+BEGIN_SRC text :exports none :noweb yes
2022
#+END_SRC

#+NAME: release-date
#+BEGIN_SRC text :exports none :noweb yes
<<release-year>>-<<release-month-day>>
#+END_SRC

#+NAME: creation-date
#+BEGIN_SRC text :exports none :noweb yes
2022-10-28
#+END_SRC

#+NAME: description
#+BEGIN_SRC text :exports none :noweb yes
PCB files for biym game.
#+END_SRC

#+NAME: license
#+BEGIN_SRC text :exports none :noweb yes
nil
#+END_SRC

#+NAME: guix-license
#+BEGIN_SRC text :exports none :noweb yes
nil
#+END_SRC

#+NAME: license-files
#+BEGIN_SRC text :exports none :noweb yes
LICENSE
#+END_SRC

#+NAME: repository-name
#+BEGIN_SRC text :exports none :noweb yes
biym-board
#+END_SRC

#+NAME: repository-organization
#+BEGIN_SRC text :exports none :noweb yes
biym
#+END_SRC

#+NAME: forge
#+BEGIN_SRC text :exports none :noweb yes
github.com
#+END_SRC

#+NAME: repository-url
#+BEGIN_SRC text :exports none :noweb yes
https://<<forge>>/<<repository-organization>>/<<repository-name>>
#+END_SRC

#+NAME: code-repository
#+BEGIN_SRC text :exports none :noweb yes
git+<<repository-url>>.git
#+END_SRC

#+NAME: guix-name
#+BEGIN_SRC text :exports none :noweb yes
nil
#+END_SRC

#+NAME: author-given-name
#+BEGIN_SRC text :exports none :noweb yes
Peter
#+END_SRC

#+NAME: author-family-name
#+BEGIN_SRC text :exports none :noweb yes
Polidoro
#+END_SRC

#+NAME: author
#+BEGIN_SRC text :exports none :noweb yes
<<author-given-name>> <<author-family-name>>
#+END_SRC

#+NAME: email
#+BEGIN_SRC text :exports none :noweb yes
peter@polidoro.io
#+END_SRC

#+NAME: affiliation
#+BEGIN_SRC text :exports none :noweb yes
Peter Polidoro
#+END_SRC

#+NAME: copyright
#+BEGIN_SRC text :exports none :noweb yes
<<release-year>> <<affiliation>>
#+END_SRC

#+NAME: programming-language
#+BEGIN_SRC text :exports none :noweb yes
KiCad
#+END_SRC

#+NAME: guix-dependencies
#+BEGIN_SRC text :exports none :noweb yes
nil
#+END_SRC

#+NAME: references
#+BEGIN_SRC text :exports none :noweb yes
https://www.adafruit.com/product/4062
https://learn.adafruit.com/adafruit-feather/feather-specification
https://github.com/adafruit/Adafruit-nRF52-Bluefruit-Feather-PCB
#+END_SRC

#+NAME: command-line-interface
#+BEGIN_SRC text :exports none :noweb yes
nil
#+END_SRC

#+NAME: documentation-dir
#+BEGIN_SRC text :exports none :noweb yes
./documentation/
#+END_SRC

#+NAME: bom-dir
#+BEGIN_SRC text :exports none :noweb yes
<<documentation-dir>>bom/
#+END_SRC

#+NAME: fabrication-dir
#+BEGIN_SRC text :exports none :noweb yes
<<documentation-dir>>fabrication/
#+END_SRC

#+NAME: pcb-dir
#+BEGIN_SRC text :exports none :noweb yes
<<documentation-dir>>pcb/
#+END_SRC

#+NAME: reference-dir
#+BEGIN_SRC text :exports none :noweb yes
<<documentation-dir>>pcb/
#+END_SRC

#+NAME: schematic-dir
#+BEGIN_SRC text :exports none :noweb yes
<<documentation-dir>>schematic/
#+END_SRC

#+BEGIN_EXAMPLE
<!-- This file is generated automatically from .metadata.org -->
<!-- File edits may be overwritten! -->
#+END_EXAMPLE

* About

#+BEGIN_SRC markdown :noweb yes
- Name: <<name>>
- Description: <<description>>
- Version: <<version>>
- Date: <<release-date>>
- License: <<license>>
- URL: <<repository-url>>
- Author: <<author>>
- Email: <<email>>
- Copyright: <<copyright>>
- References:
  - <<references>>
#+END_SRC

* Images

#+BEGIN_SRC python :noweb yes :exports results :results output raw
from pathlib import Path
path_strings = ['<<pcb-dir>>top.png', '<<pcb-dir>>bottom.png']
for path_string in path_strings:
    path = Path(path_string)
    if path.is_file():
        print(f'[[file:./{path}]]\n')
#+END_SRC

* Schematic

#+BEGIN_SRC python :noweb yes :exports results :results output raw
from pathlib import Path
path = Path('<<schematic-dir>>')
for child in path.iterdir():
    if '.pdf' in str(child):
        print(f'[[file:./{child}][./{child}]]\n')
#+END_SRC

#+BEGIN_SRC python :noweb yes :exports results :results output raw
from pathlib import Path
from re import search
from collections import OrderedDict
path = Path('<<schematic-dir>>')
svg_dict = {}
for child in path.iterdir():
    if '.svg' in str(child):
        text = child.read_text()
        # sort by Id inside svg text
        match_object = search('Id:\s*(\d*)', text)
        number = int(match_object.groups()[0])
        svg_dict[number] = f'[[file:./{child}]]'
sorted_svg_dict = OrderedDict(sorted(svg_dict.items()))
for svg_string in sorted_svg_dict.values():
    print(f'{svg_string}\n')
#+END_SRC

* PCB

#+BEGIN_SRC sh :noweb yes :exports results
inkscape --export-area-drawing --export-type=png --export-dpi=300 <<pcb-dir>>*.svg
#+END_SRC

#+RESULTS:

#+BEGIN_SRC python :noweb yes :exports results :results output raw
from pathlib import Path
path_strings = ['<<pcb-dir>><<name>>-F_Silkscreen.png',
                '<<pcb-dir>><<name>>-B_Silkscreen.png',
                '<<pcb-dir>><<name>>-User_Drawings.png']
for path_string in path_strings:
    path = Path(path_string)
    if path.is_file():
        print(f'[[file:./{path}]]\n')
#+END_SRC

* Bill of Materials

#+NAME: pcb-parts
#+BEGIN_SRC python :noweb yes :exports results :results value table
from kicad_bom import KicadBom
kb = KicadBom('./<<name>>/')
bom = kb.get_bom()
bom.insert(1,None)
return bom
#+END_SRC

* Development

** Install Guix

[[https://guix.gnu.org/manual/en/html_node/Binary-Installation.html][Install Guix]]

** Clone Repository

#+BEGIN_SRC sh :noweb yes
git clone <<repository-url>>
cd <<repository-name>>
#+END_SRC

** Edit .metadata.org

#+BEGIN_SRC sh :noweb yes
make metadata-edits
#+END_SRC

** Tangle .metadata.org

#+BEGIN_SRC sh :noweb yes
make metadata
#+END_SRC

** Edit files

#+BEGIN_SRC sh :noweb yes
make file-edits
exit
#+END_SRC

* Tangled Files                                                    :noexport:

#+BEGIN_SRC text :tangle AUTHORS :exports none :noweb yes
<<author>>
#+END_SRC

#+BEGIN_SRC text :tangle LICENSE :exports none :noweb yes
#+END_SRC

#+BEGIN_SRC js :tangle codemeta.json :exports none :noweb yes
{
    "@context": "https://doi.org/10.5063/schema/codemeta-2.0",
    "@type": "SoftwareSourceCode",
    "license": "https://spdx.org/licenses/<<license>>",
    "codeRepository": "<<code-repository>>",
    "dateCreated": "<<creation-date>>",
    "dateModified": "<<release-date>>",
    "name": "<<name>>",
    "version": "<<version>>",
    "description": "<<description>>",
    "programmingLanguage": [
        "<<programming-language>>"
    ],
    "author": [
        {
            "@type": "Person",
            "givenName": "<<author-given-name>>",
            "familyName": "<<author-family-name>>",
            "email": "<<email>>",
            "affiliation": {
                "@type": "Organization",
                "name": "<<affiliation>>"
            }
        }
    ]
}
#+END_SRC

#+BEGIN_SRC scheme :tangle .channels.scm :exports none :noweb yes
;; This file is generated automatically from .metadata.org
;; File edits may be overwritten!
(list (channel
        (name 'guix)
        (url "https://git.savannah.gnu.org/git/guix.git")
        (branch "master")
        (commit
          "2c9635cb47b0f52de635e93ebd137f1f7191c5fd")
        (introduction
          (make-channel-introduction
            "9edb3f66fd807b096b48283debdcddccfea34bad"
            (openpgp-fingerprint
              "BBB0 2DDF 2CEA F6A8 0D1D  E643 A2A0 6DF2 A33A 54FA"))))
      (channel
        (name 'guix-janelia)
        (url "https://github.com/guix-janelia/guix-janelia.git")
        (branch "main")
        (commit
          "a082913f2dcfd0aa7d1922e780880505aaf3e2d9")))
#+END_SRC

#+BEGIN_SRC scheme :tangle .manifest.scm :exports none :noweb yes
;; This file is generated automatically from .metadata.org
;; File edits may be overwritten!
(specifications->manifest
 '("kicad"
   "kicad-doc"
   "kicad-symbols"
   "kicad-footprints"
   "kicad-packages3d"
   "kicad-templates"
   "make"
   "bash"
   "git"
   "emacs"
   "emacs-org"
   "emacs-ox-gfm"
   "imagemagick"
   "inkscape"
   "python"
   "python-kicad-bom"
   "coreutils"
   "python-ipython"))
#+END_SRC

#+BEGIN_SRC text :tangle Makefile :exports none :noweb yes
# This file is generated automatically from .metadata.org
# File edits may be overwritten!

upload: metadata package twine add clean

GUIX-SHELL = guix time-machine -C .channels.scm -- shell -m .manifest.scm
GUIX-CONTAINER = $(GUIX-SHELL) --container
GUIX-CONTAINER-GUI = $(GUIX-CONTAINER) -E "^DISPLAY$$" -E "^XAUTHORITY$$" --expose="$$XAUTHORITY" --expose=/tmp/.X11-unix/ --expose=$$HOME/.Xauthority --expose=/etc/machine-id

shell:
	$(GUIX-SHELL)

container:
	$(GUIX-CONTAINER)

metadata-edits:
	$(GUIX-CONTAINER-GUI) -- sh -c "emacs -q --no-site-file --no-site-lisp --no-splash -l .init.el --file .metadata.org"

metadata:
	$(GUIX-CONTAINER) -- sh -c "emacs --batch -Q  -l .init.el --eval '(process-org \".metadata.org\")'"

file-edits:
	$(GUIX-SHELL) --pure -- kicad

ipython-shell:
	$(GUIX-CONTAINER) -- ipython

add:
	$(GUIX-CONTAINER) -- sh -c "git add --all"

clean:
	$(GUIX-CONTAINER) -- sh -c "git clean -xdf"
#+END_SRC

#+BEGIN_SRC scheme :tangle .init.el :exports none :noweb yes
;; This file is generated automatically from .metadata.org
;; File edits may be overwritten!
(require 'org)

(eval-after-load "org"
  '(require 'ox-gfm nil t))

(setq make-backup-files nil)
(setq org-confirm-babel-evaluate nil)

(org-babel-do-load-languages
 'org-babel-load-languages
 '((emacs-lisp . t)
   (lisp . t)
   (shell . t)
   (python . t)
   (scheme . t)))

(setq org-babel-python-command "python3")

(setq python-indent-guess-indent-offset t)
(setq python-indent-guess-indent-offset-verbose nil)

(defun tangle-org (org-file)
  "Tangle org file"
  (unless (string= "org" (file-name-extension org-file))
    (error "INFILE must be an org file."))
  (org-babel-tangle-file org-file))

(defun export-org (org-file)
  "Export org file to gfm file"
  (unless (string= "org" (file-name-extension org-file))
    (error "INFILE must be an org file."))
  (let ((org-file-buffer (find-file-noselect org-file)))
    (with-current-buffer org-file-buffer
      (org-open-file (org-gfm-export-to-markdown)))))

(defun process-org (org-file)
  "Tangle and export org file"
  (progn (tangle-org org-file)
         (export-org org-file)))

(make-variable-buffer-local 'org-export-filter-final-output-functions)
(defun my-double-blank-line-filter (output backend info)
  (replace-regexp-in-string "^\n+" "\n" output))
(add-to-list 'org-export-filter-final-output-functions
             'my-double-blank-line-filter)
(defun my-result-keyword-filter (output backend info)
  (replace-regexp-in-string "^#[+]RESULTS:.*\n" "" output))
(add-to-list 'org-export-filter-final-output-functions
             'my-result-keyword-filter)
(defun my-export-filename-filter (output backend info)
  (replace-regexp-in-string "^#[+]EXPORT_FILE_NAME:.*\n" "" output))
(add-to-list 'org-export-filter-final-output-functions
             'my-export-filename-filter)
#+END_SRC

